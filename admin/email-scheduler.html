<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="refresh" content="0; url=email-scheduler.php">
        <title>Redirecting...</title>
    </head>
    <body>
        <p>Redirecting to <a href="email-scheduler.php">Email Scheduler (PHP)</a>…</p>
    </body>
</html>

    <div class="tabs">
        <button class="tab active" data-target="campaigns">Campaigns</button>
        <button class="tab" data-target="new-campaign">New Campaign</button>
        <button class="tab" data-target="config">Email Config</button>
        <button class="tab" data-target="logs">Email Logs</button>
    </div>

    <div id="campaigns" class="tab-content active">
        <h2>Your Campaigns</h2>
        <div id="campaign-list">Loading campaigns...</div>
    </div>

    <div id="new-campaign" class="tab-content">
        <h2>Create New Campaign</h2>
        <div id="campaign-alert"></div>
        <form id="campaign-form">
            <div class="form-group"><label>Campaign Name</label><input name="name" required></div>
            <div class="form-group"><label>Email Subject</label><input name="subject" required></div>
            <div class="form-group"><label>Email Body</label><textarea name="body" required></textarea></div>
            <div class="form-group"><label>Recipients (one per line)</label><textarea name="recipients" placeholder="email1@example.com\nemail2@example.com" required></textarea></div>
            <div class="form-group"><label>Send on Days</label><div class="checkbox-group">
                <label><input type="checkbox" name="days" value="monday"> Monday</label>
                <label><input type="checkbox" name="days" value="tuesday"> Tuesday</label>
                <label><input type="checkbox" name="days" value="wednesday"> Wednesday</label>
                <label><input type="checkbox" name="days" value="thursday"> Thursday</label>
                <label><input type="checkbox" name="days" value="friday"> Friday</label>
                <label><input type="checkbox" name="days" value="saturday"> Saturday</label>
                <label><input type="checkbox" name="days" value="sunday"> Sunday</label>
            </div></div>
            <div class="form-group"><label>Send Time</label><input type="time" name="send_time" value="09:00" required></div>
            <div class="form-group"><label><input type="checkbox" name="active" checked> Active</label></div>
            <button class="btn btn-primary" type="submit">Create Campaign</button>
        </form>
    </div>

    <div id="config" class="tab-content">
        <h2>Email Configuration</h2>
        <form id="config-form">
            <div class="form-group"><label>SMTP Server</label><input name="smtp_server" required></div>
            <div class="form-group"><label>SMTP Port</label><input name="smtp_port" required></div>
            <div class="form-group"><label>Email Address</label><input name="email_address" type="email" required></div>
            <div class="form-group"><label>Email Password</label><input name="email_password" type="password" required></div>
            <button class="btn btn-primary" type="submit">Save Configuration</button>
        </form>
    </div>

    <div id="logs" class="tab-content">
        <h2>Email Logs</h2>
        <div id="logs-list">Loading logs...</div>
    </div>

    <!-- Edit Campaign Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Campaign</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="edit-campaign-content">
                <form id="edit-form">
                    <input type="hidden" name="id">
                    <div class="form-group"><label>Campaign Name</label><input name="name" required></div>
                    <div class="form-group"><label>Email Subject</label><input name="subject" required></div>
                    <div class="form-group"><label>Email Body</label><textarea name="body" required></textarea></div>
                    <div class="form-group"><label>Recipients (one per line)</label><textarea name="recipients" required></textarea></div>
                    <div class="form-group"><label>Send on Days</label><div class="checkbox-group">
                        <label><input type="checkbox" name="days" value="monday"> Monday</label>
                        <label><input type="checkbox" name="days" value="tuesday"> Tuesday</label>
                        <label><input type="checkbox" name="days" value="wednesday"> Wednesday</label>
                        <label><input type="checkbox" name="days" value="thursday"> Thursday</label>
                        <label><input type="checkbox" name="days" value="friday"> Friday</label>
                        <label><input type="checkbox" name="days" value="saturday"> Saturday</label>
                        <label><input type="checkbox" name="days" value="sunday"> Sunday</label>
                    </div></div>
                    <div class="form-group"><label>Send Time</label><input type="time" name="send_time" required></div>
                    <div class="form-group"><label><input type="checkbox" name="active"> Active</label></div>
                    <div style="display:flex;gap:8px"><button class="btn btn-primary" type="submit">Save Changes</button><button type="button" class="btn btn-danger" id="delete-btn">Delete</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = '/admin/api/email_api.php';
// simple tabbing
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',e=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.target).classList.add('active');
}));

function fetchJSON(url, opts={}){ return fetch(url, opts).then(r=>r.json()); }

function loadCampaigns(){
    fetchJSON(API_URL + '?action=campaigns').then(j=>{
        const list = document.getElementById('campaign-list');
        list.innerHTML = '';
        if (!j.campaigns || j.campaigns.length===0) { list.innerHTML = '<p>No campaigns</p>'; return; }
        j.campaigns.forEach(c=>{
            const el = document.createElement('div'); el.className='campaign-card';
            el.innerHTML = `
                <h3>${escapeHtml(c.name)}</h3>
                <div class="campaign-meta">${c.created_at} • ${c.recipients.length} recipients</div>
                <div class="campaign-actions">
                    <button class="btn btn-primary" data-id="${c.id}" onclick="openEdit(${c.id})">Edit</button>
                    <button class="btn btn-secondary" data-id="${c.id}" onclick="triggerSend(${c.id})">Send Now</button>
                    <button class="btn btn-danger" data-id="${c.id}" onclick="deleteCampaign(${c.id})">Delete</button>
                </div>
            `;
            list.appendChild(el);
        });
    }).catch(err=>console.error(err));
}

function openEdit(id){
    fetchJSON(API_URL + '?action=campaign&id=' + encodeURIComponent(id)).then(j=>{
        if (!j.campaign) { alert('Campaign not found'); return; }
        const c = j.campaign;
        const form = document.getElementById('edit-form');
        form.id.value = c.id;
        form.name.value = c.name;
        form.subject.value = c.subject;
        form.body.value = c.body;
        form.recipients.value = (c.recipients || []).join('\n');
        form.send_time.value = c.send_time;
        form.active.checked = !!c.active;
        // set days
        form.querySelectorAll('input[name="days"]').forEach(i=>i.checked = (c.send_days || []).includes(i.value));
        document.getElementById('edit-modal').classList.add('active');
    });
}

function closeModal(){ document.getElementById('edit-modal').classList.remove('active'); }

document.getElementById('edit-form').addEventListener('submit', function(e){
    e.preventDefault(); const fd = new FormData(e.target); const payload = {
        name: fd.get('name'), subject: fd.get('subject'), body: fd.get('body'),
        recipients: fd.get('recipients'), send_time: fd.get('send_time'), active: fd.get('active') ? 1 : 0,
        send_days: Array.from(e.target.querySelectorAll('input[name="days"]:checked')).map(i=>i.value)
    };
    const id = fd.get('id');
    fetch(API_URL + '?action=campaign&id=' + encodeURIComponent(id), { method:'PUT', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': '<?php echo htmlspecialchars(generate_csrf_token(), ENT_QUOTES); ?>' }, body: JSON.stringify(payload) })
    .then(r=>r.json()).then(j=>{ alert(j.message || JSON.stringify(j)); closeModal(); loadCampaigns(); });
});

function deleteCampaign(id){
    if (!confirm('Delete campaign #' + id + '?')) return;
    fetch(API_URL + '?action=campaign&id=' + encodeURIComponent(id), { method:'DELETE', headers: { 'X-CSRF-Token': '<?php echo htmlspecialchars(generate_csrf_token(), ENT_QUOTES); ?>' } })
    .then(r=>r.json()).then(j=>{ alert(j.message || JSON.stringify(j)); loadCampaigns(); });
}

function triggerSend(id){
    fetch(API_URL + '?action=send', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': '<?php echo htmlspecialchars(generate_csrf_token(), ENT_QUOTES); ?>' }, body: JSON.stringify({ campaign_id: id }) })
    .then(r=>r.json()).then(j=>{ alert(j.message || JSON.stringify(j)); });
}

// Load logs
function loadLogs(){
    fetchJSON(API_URL + '?action=logs').then(j=>{
        const el = document.getElementById('logs-list'); el.innerHTML = '';
        if (!j.logs || j.logs.length===0) { el.innerHTML = '<p>No logs</p>'; return; }
        j.logs.forEach(l=>{
            const d = document.createElement('div'); d.className='campaign-card';
            d.innerHTML = `<div><strong>${escapeHtml(l.status)}</strong> ${l.sent_at} - Campaign #${l.campaign_id || 'n/a'}<div>${escapeHtml(l.message)}</div></div>`;
            el.appendChild(d);
        });
    });
}

// Hook log tab to load logs when clicked
document.querySelector('[data-target="logs"]').addEventListener('click', ()=>setTimeout(loadLogs, 200));

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

// Create campaign
document.getElementById('campaign-form').addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(e.target); const payload = {};
    payload.name = fd.get('name'); payload.subject = fd.get('subject'); payload.body = fd.get('body');
    payload.recipients = fd.get('recipients');
    payload.send_time = fd.get('send_time'); payload.active = fd.get('active') ? 1 : 0;
    payload.send_days = Array.from(e.target.querySelectorAll('input[name="days"]:checked')).map(i=>i.value);

    fetch(API_URL + '?action=campaign', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': '<?php echo htmlspecialchars(generate_csrf_token(), ENT_QUOTES); ?>' },
        body: JSON.stringify(payload)
    }).then(r=>r.json()).then(j=>{
        alert(j.message || JSON.stringify(j)); loadCampaigns();
    }).catch(err=>{ alert('Error creating campaign'); console.error(err); });
});

// Config save
document.getElementById('config-form').addEventListener('submit', function(e){
    e.preventDefault(); const fd=new FormData(e.target); const payload={};
    ['smtp_server','smtp_port','email_address','email_password'].forEach(k=>payload[k]=fd.get(k));
    fetch(API_URL + '?action=config', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': '<?php echo htmlspecialchars(generate_csrf_token(), ENT_QUOTES); ?>' }, body: JSON.stringify(payload) })
    .then(r=>r.json()).then(j=>{ alert(j.message || JSON.stringify(j)); });
});

// Load initial data
loadCampaigns();

</script>

<?php include __DIR__ . '/_admin_footer.php'; // optional footer ?>
</body>
</html>
