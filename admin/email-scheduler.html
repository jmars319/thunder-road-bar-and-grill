<?php
require_once __DIR__ . '/config.php';
require_admin();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Email Scheduler - Admin</title>
    <link rel="stylesheet" href="/assets/css/admin.css">
    <style>
        /* Inline critical styles from package to keep page self-contained */
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial; background:#f5f7fa; color:#333; }
        .container{max-width:1100px;margin:20px auto;padding:20px}
        .tabs{display:flex;gap:8px;margin-bottom:16px}
        .tab{padding:8px 12px;background:#fff;border-radius:6px;cursor:pointer}
        .tab.active{background:#3498db;color:#fff}
        .tab-content{display:none;background:#fff;padding:16px;border-radius:8px}
        .tab-content.active{display:block}
    </style>
</head>
<body>
<?php include __DIR__ . '/_admin_header.php'; // optional project-specific header (may not exist) ?>
<div class="container">
    <h1>Email Scheduler Admin</h1>
    <p>Manage automated email campaigns</p>

    <div class="tabs">
        <button class="tab active" data-target="campaigns">Campaigns</button>
        <button class="tab" data-target="new-campaign">New Campaign</button>
        <button class="tab" data-target="config">Email Config</button>
        <button class="tab" data-target="logs">Email Logs</button>
    </div>

    <div id="campaigns" class="tab-content active">
        <h2>Your Campaigns</h2>
        <div id="campaign-list">Loading campaigns...</div>
    </div>

    <div id="new-campaign" class="tab-content">
        <h2>Create New Campaign</h2>
        <div id="campaign-alert"></div>
        <form id="campaign-form">
            <div class="form-group"><label>Campaign Name</label><input name="name" required></div>
            <div class="form-group"><label>Email Subject</label><input name="subject" required></div>
            <div class="form-group"><label>Email Body</label><textarea name="body" required></textarea></div>
            <div class="form-group"><label>Recipients (one per line)</label><textarea name="recipients" placeholder="email1@example.com\nemail2@example.com" required></textarea></div>
            <div class="form-group"><label>Send on Days</label><div class="checkbox-group">
                <label><input type="checkbox" name="days" value="monday"> Monday</label>
                <label><input type="checkbox" name="days" value="tuesday"> Tuesday</label>
                <label><input type="checkbox" name="days" value="wednesday"> Wednesday</label>
                <label><input type="checkbox" name="days" value="thursday"> Thursday</label>
                <label><input type="checkbox" name="days" value="friday"> Friday</label>
                <label><input type="checkbox" name="days" value="saturday"> Saturday</label>
                <label><input type="checkbox" name="days" value="sunday"> Sunday</label>
            </div></div>
            <div class="form-group"><label>Send Time</label><input type="time" name="send_time" value="09:00" required></div>
            <div class="form-group"><label><input type="checkbox" name="active" checked> Active</label></div>
            <button class="btn btn-primary" type="submit">Create Campaign</button>
        </form>
    </div>

    <div id="config" class="tab-content">
        <h2>Email Configuration</h2>
        <form id="config-form">
            <div class="form-group"><label>SMTP Server</label><input name="smtp_server" required></div>
            <div class="form-group"><label>SMTP Port</label><input name="smtp_port" required></div>
            <div class="form-group"><label>Email Address</label><input name="email_address" type="email" required></div>
            <div class="form-group"><label>Email Password</label><input name="email_password" type="password" required></div>
            <button class="btn btn-primary" type="submit">Save Configuration</button>
        </form>
    </div>

    <div id="logs" class="tab-content">
        <h2>Email Logs</h2>
        <div id="logs-list">Loading logs...</div>
    </div>
</div>

<script>
const API_URL = '/admin/api/email_api.php';
// simple tabbing
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',e=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.target).classList.add('active');
}));

function fetchJSON(url, opts={}){ return fetch(url, opts).then(r=>r.json()); }

function loadCampaigns(){
    fetchJSON(API_URL + '?action=campaigns').then(j=>{
        const list = document.getElementById('campaign-list');
        list.innerHTML = '';
        if (!j.campaigns || j.campaigns.length===0) { list.innerHTML = '<p>No campaigns</p>'; return; }
        j.campaigns.forEach(c=>{
            const el = document.createElement('div'); el.className='campaign-card';
            el.innerHTML = `<h3>${escapeHtml(c.name)}</h3><div class="campaign-meta">${c.created_at} â€¢ ${c.recipients.length} recipients</div>`;
            list.appendChild(el);
        });
    }).catch(err=>console.error(err));
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

// Create campaign
document.getElementById('campaign-form').addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(e.target); const payload = {};
    payload.name = fd.get('name'); payload.subject = fd.get('subject'); payload.body = fd.get('body');
    payload.recipients = fd.get('recipients');
    payload.send_time = fd.get('send_time'); payload.active = fd.get('active') ? 1 : 0;
    payload.send_days = Array.from(e.target.querySelectorAll('input[name="days"]:checked')).map(i=>i.value);

    fetch(API_URL + '?action=campaign', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': '<?php echo htmlspecialchars(generate_csrf_token(), ENT_QUOTES); ?>' },
        body: JSON.stringify(payload)
    }).then(r=>r.json()).then(j=>{
        alert(j.message || JSON.stringify(j)); loadCampaigns();
    }).catch(err=>{ alert('Error creating campaign'); console.error(err); });
});

// Config save
document.getElementById('config-form').addEventListener('submit', function(e){
    e.preventDefault(); const fd=new FormData(e.target); const payload={};
    ['smtp_server','smtp_port','email_address','email_password'].forEach(k=>payload[k]=fd.get(k));
    fetch(API_URL + '?action=config', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': '<?php echo htmlspecialchars(generate_csrf_token(), ENT_QUOTES); ?>' }, body: JSON.stringify(payload) })
    .then(r=>r.json()).then(j=>{ alert(j.message || JSON.stringify(j)); });
});

// Load initial data
loadCampaigns();

</script>

<?php include __DIR__ . '/_admin_footer.php'; // optional footer ?>
</body>
</html>
